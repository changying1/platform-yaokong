===== LOW-LATENCY STREAMING DEPLOYMENT GUIDE =====

All changes have been successfully applied! Here's what was modified:

1. MEDIA SERVER (NMS) - media_server/app.js
   - Disabled HLS generation (hls: true removed from trans.tasks)
   - Using direct FLV streaming for lower latency
   - Removed automatic transcoding for better real-time performance

2. FRONTEND PLAYER - frontend/src/components/VideoPlayer.tsx
   - Switched from hls.js to flv.js for FLV playback
   - Added low-latency configuration:
     * bufferingDuration: 0.5s (minimal buffering)
     * deferredLoadThreshold: 0 (no prefetching delay)
   - Automatic HLS-to-FLV URL conversion (.m3u8 → .flv)
   - Better error handling and fallback support

3. BACKEND SERVICE - backend/app/services/video_service.py
   - Changed stream URLs from HLS (index.m3u8) to FLV (.flv)
   - Updated video service to generate FLV stream addresses
   - Lower-latency push recommended (no -re flag)

4. FRONTEND DEPENDENCIES - frontend/package.json
   - Added flv.js@^1.6.2 dependency

5. CACHE CLEANUP
   - Cleared media/live directory to prevent old HLS fragments

===== DEPLOYMENT STEPS =====

Step 1: Install frontend dependencies
  cd frontend
  npm install

Step 2: Verify NMS configuration
  - Ensure Node Media Server app.js is using the updated config
  - Key point: trans.tasks is empty (no HLS generation)

Step 3: Restart all services
  a) Stop current NMS if running (Ctrl+C)
  b) Start NMS:
     node media_server/app.js
  
  c) Start backend (from root):
     python backend/main.py
  
  d) Start frontend:
     cd frontend
     npm run dev

Step 4: Test streaming
  - Add camera via backend API
  - Stream URL will now be: http://127.0.0.1:8001/live/{stream_name}.flv
  - Frontend will automatically detect and play as FLV
  - Expected latency: 1-3 seconds (vs 20-30 seconds with HLS)

===== FFMPEG PUSH COMMAND (Optional) =====

For lower-latency push from your RTSP source, use:

ffmpeg -rtsp_transport tcp \
  -i "rtsp://admin:Song%40871023@10.102.7.154/Streaming/Channels/1" \
  -fflags nobuffer -flags low_delay -rtbufsize 100M \
  -c:v copy -c:a aac -ar 44100 -b:a 128k \
  -f flv rtmp://127.0.0.1:19350/live/教室

Key improvements:
- Removed -re flag (was causing deliberate buffering)
- Added -fflags nobuffer (no input buffering)
- Added -flags low_delay (minimize output delay)
- Direct codec copy for faster processing

===== TROUBLESHOOTING =====

If video still appears delayed:
1. Check browser console for FLV player errors
2. Verify NMS is receiving stream: check NMS logs for "rtmp publish" events
3. Check network latency between components
4. Ensure no caching headers in HTTP responses

If video is choppy or stops:
1. Check network bandwidth (video codec and bitrate)
2. Verify ffmpeg source is stable and not throttled
3. Consider GPU acceleration for H.264 decoding in browser

===== EXPECTED IMPROVEMENTS =====

BEFORE (HLS):
- Playback delay: 20-30 seconds
- Appearance: like video replay
- Segment overhead: 3 sec/segment × 40 buffer = 120s+ history

AFTER (FLV):
- Playback delay: 1-3 seconds
- Appearance: real-time live stream
- Minimal buffering: only 0.5 seconds
- Smooth playback with proper sync

Enjoy your low-latency live streaming!
